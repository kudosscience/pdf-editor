# 2-7 True image replacement undo
[Back to task list](./tasks.md)

## Description
Implement true undo for image replacement operations. Currently, `handleReplaceImage` in the renderer creates an `EditCommand` whose `undo()` is a no-op stub (`setStatus('Image undo not fully supported yet')`). This task stores the original image data before replacement so that undo can restore it.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 10:35:00 | Created | N/A | Proposed | Deferred from task 2-4 — image undo TODO | AI_Agent |

## Requirements
- Before sending `pdf:replace-image`, extract the current image object's data (or render a bitmap snapshot of it).
- Store the original image data in the `EditCommand`'s closure.
- On `undo()`, call `pdf:replace-image` with the original data to restore the previous image.
- On `redo()`, re-apply the replacement image.
- Memory management: ensure large image buffers are released when the command falls off the undo stack.

## Implementation Plan
1. Add a `pdf:get-image-data` IPC channel (or use `listPageObjects` extended info) to retrieve current image bytes.
2. In `handleReplaceImage`, fetch original image data before executing the replacement.
3. Store original data in the command closure; implement `undo()` to call `pdf:replace-image` with original.
4. Consider memory limits — drop oldest image data if undo stack exceeds a threshold.

## Test Plan
- **Undo image replace:** Replace image → undo → original image restored visually and in re-render.
- **Redo image replace:** Undo → redo → replacement image re-applied.
- **Memory:** Replace multiple images → verify memory does not grow unbounded.

## Verification
- Image undo/redo works correctly across save/reopen cycles.
- No memory leaks from stored image data.

## Files Modified
- `src/renderer/app.ts` — Update handleReplaceImage to store original data; implement real undo
- `src/main/ipc-handlers.ts` — Possibly add pdf:get-image-data handler
- `native/pdfium/src/objects.cc` — Possibly add GetImageData function
