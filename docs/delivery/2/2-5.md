# 2-5 Save semantics and reopen verification
[Back to task list](./tasks.md)

## Description
Implement reliable save semantics: incremental save via PDFium, dirty flag management, and a verification step that confirms edits persist when the document is reopened. Ensure save does not corrupt document structure or unreasonably inflate file size.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements
- `pdf:save` handler calls `PdfiumEngine.save()` which uses `FPDF_SaveAsCopy` to serialize the document.
- Save overwrites the original file (Ctrl+S) or prompts for new path (Ctrl+Shift+S / Save As).
- Clear dirty flag after successful save; emit `document:saved` event.
- If save fails, emit `document:error` with descriptive message; dirty flag remains.
- File size after save should not exceed 2× the original size for equivalent content (guard against bloat).
- After save, optionally verify by reopening the saved file and comparing page count and first-page render hash.

## Implementation Plan
1. Ensure `pdf:save` handler in `src/main/ipc-handlers.ts` calls façade `save()`, writes buffer to disk, emits events.
2. Wire Save/Save As buttons and keyboard shortcuts to IPC calls.
3. Track original file size; log warning if saved file exceeds 2× threshold.
4. Implement optional reopen-verify: close document, reopen saved file, compare page count and render hash.
5. Update status bar on save success/failure.

## Test Plan
- **Save:** Edit text → save → file written to disk; dirty flag cleared.
- **Save As:** Edit → Save As → new file created; original unchanged.
- **Reopen:** Save → close → reopen → page count matches; first page renders identically.
- **External viewer:** Open saved file in Chrome/Adobe Reader → edits visible.
- **Bloat check:** Saved file size within 2× of original for simple edits.
- **Failure:** Attempt save to read-only path → error shown; dirty flag remains.

## Verification
- Save/Save As produce valid PDFs.
- Edits persist across reopen cycles.
- No document corruption detected in external viewers.

## Files Modified
- `src/main/ipc-handlers.ts` — pdf:save handler with write, events, size check
- `src/renderer/app.ts` — Save/Save As wiring, dirty flag management
