# 2-5 Save semantics and reopen verification
[Back to task list](./tasks.md)

## Description
Implement reliable save semantics: incremental save via PDFium, dirty flag management, and a verification step that confirms edits persist when the document is reopened. Ensure save does not corrupt document structure or unreasonably inflate file size.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 10:00:00 | Status Change | Proposed | Agreed | Fast-tracked: full implementation already exists from PBI 1 scaffolding | User |
| 2026-02-19 10:00:00 | Status Change | Agreed | InProgress | Implementation verified against requirements | AI_Agent |
| 2026-02-19 10:01:00 | Status Change | InProgress | Review | All requirements met: FPDF_SaveAsCopy via save(), Save/Save As with keyboard shortcuts, dirty flag clearing, error handling, file write via IPC | AI_Agent |
| 2026-02-21 09:30:00 | Bug Fix | Review | Review | Fixed crash-on-save: FPDF_LoadMemDocument buffer not pinned — added pinnedBuffers map to PdfiumEngine to prevent GC of the buffer while PDFium holds a pointer to it. 15/15 E2E tests pass. | AI_Agent |
| 2026-02-21 11:00:00 | Bug Fix | Review | Review | Fixed text/font corruption after editing: FPDFPage_GenerateContent re-serialises the entire page content stream, corrupting subset-font encodings (tofu glyphs) and TJ-based word spacing (spaces removed). Implemented page cache architecture — edited pages stay open in memory, GenerateContent deferred to save time, rendering uses correct in-memory objects. Files changed: common.h, addon.cc, objects.cc, render.cc, document.cc. 15/15 E2E tests pass. | AI_Agent |

## Requirements
- `pdf:save` handler calls `PdfiumEngine.save()` which uses `FPDF_SaveAsCopy` to serialize the document.
- Save overwrites the original file (Ctrl+S) or prompts for new path (Ctrl+Shift+S / Save As).
- Clear dirty flag after successful save; emit `document:saved` event.
- If save fails, emit `document:error` with descriptive message; dirty flag remains.
- File size after save should not exceed 2× the original size for equivalent content (guard against bloat).
- After save, optionally verify by reopening the saved file and comparing page count and first-page render hash.

## Implementation Plan
1. Ensure `pdf:save` handler in `src/main/ipc-handlers.ts` calls façade `save()`, writes buffer to disk, emits events.
2. Wire Save/Save As buttons and keyboard shortcuts to IPC calls.
3. Track original file size; log warning if saved file exceeds 2× threshold.
4. Implement optional reopen-verify: close document, reopen saved file, compare page count and render hash.
5. Update status bar on save success/failure.

## Test Plan
- **Save:** Edit text → save → file written to disk; dirty flag cleared.
- **Save As:** Edit → Save As → new file created; original unchanged.
- **Reopen:** Save → close → reopen → page count matches; first page renders identically.
- **External viewer:** Open saved file in Chrome/Adobe Reader → edits visible.
- **Bloat check:** Saved file size within 2× of original for simple edits.
- **Failure:** Attempt save to read-only path → error shown; dirty flag remains.

## Verification
- Save/Save As produce valid PDFs.
- Edits persist across reopen cycles.
- No document corruption detected in external viewers.

## Files Modified
- `src/main/ipc-handlers.ts` — pdf:save handler with write, events, size check
- `src/renderer/app.ts` — Save/Save As wiring, dirty flag management
- `src/main/pdfium.ts` — Added `pinnedBuffers` map to keep document buffer alive for FPDF_LoadMemDocument
- `native/pdfium/src/common.h` — Added CachedPage struct, g_pageCache extern, page cache helper declarations
- `native/pdfium/src/addon.cc` — Implemented page cache helpers (AcquirePage, ReleasePage, CachePageDirty, FlushAndCloseCachedPages, DiscardCachedPages)
- `native/pdfium/src/objects.cc` — All edit/list functions use page cache; GenerateContent deferred
- `native/pdfium/src/render.cc` — RenderPage uses AcquirePage/ReleasePage for cached page reuse
- `native/pdfium/src/document.cc` — SaveDocument flushes dirty cache before save; CloseDocument discards cache
