# 2-3 Image replacement
[Back to task list](./tasks.md)

## Description
Implement `replaceImageObject` in the native PDFium addon and expose it through the TypeScript façade and IPC layer. This allows replacing an embedded image in the PDF with a new PNG or JPEG image provided by the user.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 10:00:00 | Status Change | Proposed | Agreed | JPEG path already implemented; PNG with alpha needs new native function using FPDFBitmap_CreateEx + FPDFImageObj_SetBitmap | User |
| 2026-02-19 10:05:00 | Status Change | Agreed | InProgress | Implementing PNG support: decode via Electron nativeImage → BGRA → new native replaceImageObjectBitmap | AI_Agent |
| 2026-02-19 10:30:00 | Status Change | InProgress | Review | PNG support implemented: native ReplaceImageObjectBitmap using FPDFBitmap_CreateEx+FPDFImageObj_SetBitmap, facade decodes PNG via Electron nativeImage to BGRA. Native addon and TS build clean. All 7 existing E2E tests pass. | AI_Agent |

## Requirements
- Addon function: `replaceImageObject(handle, pageIndex, objectId, imageBuffer, format: 'png' | 'jpeg')`.
  - Decode the provided image; update the PDF's image stream for the specified object.
  - Preserve original object position and transform.
  - Support PNG with alpha transparency.
- IPC `pdf:replace-image` channel accepts `{ docId, pageIndex, objectId, image: Uint8Array, format }` and returns `{ ok: true }`.
- Façade validates: `image.byteLength <= MAX_IMAGE_BYTES`; format is `'png'` or `'jpeg'`; valid objectId.
- Error handling: return clear error if object not found, image decoding fails, or format unsupported.
- After replace, invalidate render cache for the affected page.

## Implementation Plan
1. Implement `replaceImageObject` in `native/pdfium/src/objects.cc` using PDFium's image object APIs.
2. Add wrapper in `src/main/pdfium.ts` with validation and size check.
3. Wire `pdf:replace-image` IPC handler in `src/main/ipc-handlers.ts`.
4. Add `replaceImage()` to preload bridge.
5. Invalidate render cache for the affected page after replacement.

## Test Plan
- **JPEG replace:** Replace image in `embedded-images.pdf` with JPEG → save → reopen → new image visible.
- **PNG replace:** Replace with PNG with alpha → save → reopen → transparency preserved.
- **Oversized:** Provide image exceeding `MAX_IMAGE_BYTES` → rejected with error message.
- **Invalid format:** Provide unsupported format string → rejected.
- **Invalid objectId:** Non-existent ID → error returned.
- **Persistence:** Replace → save → close → reopen → replacement persists.

## Verification
- Replaced images display correctly at various zoom levels.
- PNG transparency renders properly.
- No document corruption after replacement.

## Files Modified
- `native/pdfium/src/objects.cc` — replaceImageObject implementation
- `src/main/pdfium.ts` — replaceImageObject wrapper with validation
- `src/main/ipc-handlers.ts` — pdf:replace-image handler
- `src/preload/index.ts` — pdf.replaceImage() bridge method
- `src/shared/ipc-schema.ts` — ReplaceImagePayload type
