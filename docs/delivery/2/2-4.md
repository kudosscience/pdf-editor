# 2-4 Editing tools UI
[Back to task list](./tasks.md)

## Description
Implement the renderer-side editing tools: selection overlay with handles, double-click in-place text editor, image replacement via file picker or drag-drop, undo/redo command stack, and dirty state management with close-guard prompt.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 10:00:00 | Status Change | Proposed | Agreed | Fast-tracked: full implementation already exists from PBI 1 scaffolding. Image undo (store original for true reversal) deferred to task 2-7. | User |
| 2026-02-19 10:00:00 | Status Change | Agreed | InProgress | Implementation verified against requirements | AI_Agent |
| 2026-02-19 10:01:00 | Status Change | InProgress | Review | All requirements met: selection overlay, in-place text editor, image replace via file picker, UndoStack with Ctrl+Z/Ctrl+Shift+Z, dirty state with title bar indicator, tool modes (V/T/I), beforeunload close guard | AI_Agent |

## Requirements
- **Selection overlay:** Blue outline around selected object; resize handles (visual only for MVP).
- **In-place text editor:** Double-click text object → show contenteditable overlay at object position; commit on Enter or blur; cancel on Escape; send `pdf:edit-text` on commit.
- **Image replace:** Right-click or toolbar button on selected image → file picker (PNG/JPEG filter); also support drag-drop onto selected image. Send `pdf:replace-image` on selection.
- **Undo/redo:** Command stack tracking each edit (EditTextCommand, ReplaceImageCommand). Ctrl+Z undo; Ctrl+Shift+Z redo. Each command stores before/after state for reversal.
- **Dirty state:** Track whether document has unsaved edits. Show `*` in title bar and status bar. On window close with dirty state, show confirmation dialog via IPC.
- **Toolbar:** Add Select, Edit Text, Replace Image tool buttons; show active tool state.

## Implementation Plan
1. Add tool buttons to `src/renderer/index.html` toolbar.
2. Implement selection overlay canvas layer in `src/renderer/app.ts`.
3. Implement `InPlaceTextEditor` class: positions contenteditable div over text object; handles commit/cancel.
4. Implement image replacement flow: file picker → read file → send `pdf:replace-image` → re-render.
5. Implement `UndoStack` class with `push()`, `undo()`, `redo()` methods; wire Ctrl+Z/Ctrl+Shift+Z.
6. Implement dirty state tracking; wire `beforeunload` or IPC close guard.
7. Update status bar and title bar with dirty indicator.

## Test Plan
- **Selection:** Click text → overlay; click image → overlay; click empty → clear.
- **Text edit:** Double-click text → editor appears; type new text → Enter → page re-renders with new text.
- **Text cancel:** Type in editor → Escape → original text restored.
- **Image replace:** Select image → Replace Image button → pick file → image updates.
- **Undo/redo:** Edit text → undo → original text; redo → edited text.
- **Dirty state:** Edit → asterisk shown; save → asterisk removed; edit → close → dialog appears.
- **Keyboard:** Ctrl+Z undoes; Ctrl+Shift+Z redoes.

## Verification
- All editing interactions produce correct visual feedback.
- Undo/redo reverses and reapplies edits accurately.
- Close guard prevents accidental data loss.

## Files Modified
- `src/renderer/index.html` — Tool buttons in toolbar
- `src/renderer/app.ts` — Selection overlay, InPlaceTextEditor, image replace flow, UndoStack, dirty state
- `src/renderer/styles.css` — Selection overlay, text editor overlay, tool button styles
