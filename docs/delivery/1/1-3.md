# 1-3 TypeScript façade and error normalization
[Back to task list](./tasks.md)

## Description
Create a `PdfiumEngine` class in `src/main/pdfium.ts` that wraps the native PDFium addon with strong TypeScript types, document lifecycle management (handle tracking, cleanup on close), and normalized error handling that converts addon exceptions into consistent `{ code, message }` objects.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements
- Load the native addon from the correct platform-specific path (respecting `asarUnpack`).
- Expose typed async methods matching the IPC contract:
  - `open(input: Buffer, password?: string): Promise<{ docId: string, pageCount: number }>`
  - `close(docId: string): Promise<void>`
  - `getPageCount(docId: string): Promise<number>`
  - `renderPage(docId: string, pageIndex: number, scale: number, rotation: number): Promise<RenderResult>`
  - `listPageObjects(docId: string, pageIndex: number): Promise<PageObject[]>`
  - `save(docId: string): Promise<Buffer>`
- Generate unique `docId` strings (UUIDs) and maintain an internal `Map<string, number>` mapping docId → native handle.
- Validate inputs before calling the addon: reject negative page indices, scales outside `[0.1, 10.0]`, unknown docIds.
- Normalize errors: catch native exceptions and map to `PdfiumError { code: string, message: string }`.
- Provide a `closeAll()` method for cleanup on app quit.
- Log errors once via `console.error`; do not let duplicate logs propagate.

## Implementation Plan
1. Create `src/main/pdfium.ts` with `PdfiumEngine` class.
2. Implement addon loading with platform-aware path resolution.
3. Implement document handle registry (`Map<string, number>`).
4. Implement each method with input validation → addon call → error normalization.
5. Export singleton instance and types.

## Test Plan
- **Input Validation:** Invalid docId, negative page index, out-of-range scale all throw `PdfiumError` with appropriate codes.
- **Lifecycle:** Open returns unique docId; close removes from registry; double-close throws `DOCUMENT_NOT_FOUND`.
- **Error Normalization:** Corrupt PDF, wrong password, and native crashes all produce consistent `PdfiumError` objects.
- **CloseAll:** Multiple open docs all closed; registry empty after `closeAll()`.

## Verification
- All methods return TypeScript-typed results.
- No unhandled native exceptions propagate to IPC layer.
- Document registry stays consistent under open/close interleaving.

## Files Modified
- `src/main/pdfium.ts` — New file: PdfiumEngine class, types, singleton export
