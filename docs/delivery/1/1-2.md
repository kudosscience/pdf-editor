# 1-2 Native PDFium addon
[Back to task list](./tasks.md)

## Description
Implement a native N-API addon under `native/pdfium` that wraps the PDFium C library, exposing document lifecycle, page rendering, object listing, and save operations to Node.js. The addon is prebuilt per OS/arch and loaded by the TypeScript façade in `src/main/pdfium.ts`.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 19:56:00 | Status Change | Proposed | Agreed | Task approved by user | User |
| 2026-02-18 19:56:00 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 10:30:00 | Status Change | InProgress | Review | Implementation complete — addon builds, loads in Electron, all exports functional | AI_Agent |
| 2026-02-18 21:20:00 | Status Change | Review | Done | Approved by user; preload bundling fix confirmed addon loads correctly | User |

## Requirements
- Use `node-addon-api` (N-API) for ABI stability across Electron versions.
- Expose the following functions via the addon:
  - `openDocument(buffer: Buffer, password?: string): number` — returns a numeric document handle.
  - `closeDocument(handle: number): void` — releases all resources for the handle.
  - `getPageCount(handle: number): number` — returns the number of pages.
  - `renderPage(handle: number, pageIndex: number, scale: number, rotation: number): { width: number, height: number, data: Buffer }` — renders a page to an BGRA bitmap.
  - `listPageObjects(handle: number, pageIndex: number): Array<{ id: number, type: 'text' | 'image', left: number, top: number, right: number, bottom: number }>` — lists text and image objects with bounding boxes.
  - `saveDocument(handle: number): Buffer` — serializes the (possibly modified) document to a buffer.
- Validate all inputs (handle existence, page bounds, scale range).
- Return descriptive error messages on failure (e.g., password required, corrupt PDF).
- Support loading encrypted PDFs with a password.
- Prebuilt binaries for: win32-x64, darwin-x64, darwin-arm64, linux-x64.

## Implementation Plan
1. Created `scripts/download-pdfium.js` — downloads prebuilt PDFium shared binaries from `bblanchon/pdfium-binaries` for the current platform (win32-x64, darwin-x64, darwin-arm64, linux-x64) into `native/pdfium/vendor/`.
2. Created `native/pdfium/binding.gyp` — node-gyp build config with platform-specific linking (import lib on Windows, rpath on macOS/Linux) and shared lib copy to build output.
3. Implemented C++ N-API addon in `native/pdfium/src/`:
   - `common.h` — shared globals (document map, handle counter, init guard).
   - `addon.cc` — module entry, `FPDF_InitLibraryWithConfig`, cleanup hook.
   - `document.h/cc` — `OpenDocument`, `CloseDocument`, `GetPageCount`, `SaveDocument` (callback-based `FPDF_SaveAsCopy` with `BufferWriter`).
   - `render.h/cc` — `RenderPage` with BGRA→RGBA conversion and `FPDF_ANNOT|FPDF_PRINTING|FPDF_LCD_TEXT` flags.
   - `objects.h/cc` — `ListPageObjects`, `EditTextObject` (UTF-16LE via `FPDFText_SetText`), `ReplaceImageObject` (JPEG only via `FPDFImageObj_LoadJpegFileInline`).
4. Updated `package.json` with `download:pdfium` / `build:native` scripts, `node-gyp@^12.2.0`, and `asarUnpack` pattern.
5. Upgraded `node-gyp` from v9.4.1 → v12.2.0 (Python 3.13+ compatibility).
6. Fixed compile errors: `FPDF_FALSE` → `0`, `m_pParam` → `m_Param` in `objects.cc`.

## Test Plan
- **Compilation:** Addon compiles on all three platforms without errors.
- **Open/Close:** Opens a valid PDF; returns handle > 0; close succeeds; double-close throws.
- **Page Count:** Returns correct count for 1-page and multi-page PDFs.
- **Render:** Rendered bitmap has expected dimensions for known PDFs at scale 1.0 and 2.0.
- **Object Listing:** Lists known text and image objects from test fixtures with correct types and approximate bounding boxes.
- **Save:** Saved buffer can be reopened; page count and render output match.
- **Errors:** Invalid handle throws; out-of-range page index throws; corrupt PDF returns descriptive error.
- **Encrypted PDF:** Opens with correct password; rejects wrong password.

## Verification
- ✅ Addon compiles on win32-x64 (node-gyp rebuild) — `pdfium.node` 170KB.
- ✅ `pdfium.dll` (5.8MB) copied to `build/Release/` alongside addon.
- ✅ TypeScript build (`npm run build`) passes cleanly.
- ✅ App launches (`npm run dev`) and loads the real addon — no "Native addon not found" fallback message.
- ⏳ Cross-platform builds (macOS, Linux) not yet verified — requires CI or target machines.
- ⏳ Detailed functional tests deferred to task 1-7 (E2E CoS Test).

## Files Modified
- `scripts/download-pdfium.js` — **New**: Downloads prebuilt PDFium binaries per platform
- `native/pdfium/binding.gyp` — **New**: node-gyp build configuration
- `native/pdfium/src/common.h` — **New**: Shared state (document map, handle counter)
- `native/pdfium/src/addon.cc` — **New**: N-API module entry, init/cleanup
- `native/pdfium/src/document.h` — **New**: Document function declarations
- `native/pdfium/src/document.cc` — **New**: Open, close, page count, save
- `native/pdfium/src/render.h` — **New**: Render function declaration
- `native/pdfium/src/render.cc` — **New**: Page rendering with BGRA→RGBA conversion
- `native/pdfium/src/objects.h` — **New**: Object function declarations
- `native/pdfium/src/objects.cc` — **New**: Object listing, text editing, image replacement
- `package.json` — **Modified**: Added download:pdfium/build:native scripts, node-gyp@^12.2.0, asarUnpack pattern
- `.gitignore` — **Modified**: Added native/pdfium/build/ and native/pdfium/vendor/
- `docs/delivery/1/1-2-pdfium-guide.md` — **New**: External package research guide (policy 2.1.9)
