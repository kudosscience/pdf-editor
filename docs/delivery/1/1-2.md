# 1-2 Native PDFium addon
[Back to task list](./tasks.md)

## Description
Implement a native N-API addon under `native/pdfium` that wraps the PDFium C library, exposing document lifecycle, page rendering, object listing, and save operations to Node.js. The addon is prebuilt per OS/arch and loaded by the TypeScript façade in `src/main/pdfium.ts`.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements
- Use `node-addon-api` (N-API) for ABI stability across Electron versions.
- Expose the following functions via the addon:
  - `openDocument(buffer: Buffer, password?: string): number` — returns a numeric document handle.
  - `closeDocument(handle: number): void` — releases all resources for the handle.
  - `getPageCount(handle: number): number` — returns the number of pages.
  - `renderPage(handle: number, pageIndex: number, scale: number, rotation: number): { width: number, height: number, data: Buffer }` — renders a page to an BGRA bitmap.
  - `listPageObjects(handle: number, pageIndex: number): Array<{ id: number, type: 'text' | 'image', left: number, top: number, right: number, bottom: number }>` — lists text and image objects with bounding boxes.
  - `saveDocument(handle: number): Buffer` — serializes the (possibly modified) document to a buffer.
- Validate all inputs (handle existence, page bounds, scale range).
- Return descriptive error messages on failure (e.g., password required, corrupt PDF).
- Support loading encrypted PDFs with a password.
- Prebuilt binaries for: win32-x64, darwin-x64, darwin-arm64, linux-x64.

## Implementation Plan
1. Set up `native/pdfium/` with `binding.gyp`, `CMakeLists.txt` or `prebuildify` config.
2. Download and link prebuilt PDFium static libraries per platform.
3. Implement C++ wrapper functions using PDFium's FPDF* API.
4. Expose via `Napi::Object Init(Napi::Env, Napi::Object)`.
5. Add `prebuildify` scripts to produce `.node` per OS/arch.
6. Ensure the addon loads correctly when packaged via electron-builder (`asarUnpack`).

## Test Plan
- **Compilation:** Addon compiles on all three platforms without errors.
- **Open/Close:** Opens a valid PDF; returns handle > 0; close succeeds; double-close throws.
- **Page Count:** Returns correct count for 1-page and multi-page PDFs.
- **Render:** Rendered bitmap has expected dimensions for known PDFs at scale 1.0 and 2.0.
- **Object Listing:** Lists known text and image objects from test fixtures with correct types and approximate bounding boxes.
- **Save:** Saved buffer can be reopened; page count and render output match.
- **Errors:** Invalid handle throws; out-of-range page index throws; corrupt PDF returns descriptive error.
- **Encrypted PDF:** Opens with correct password; rejects wrong password.

## Verification
- Addon loads in Electron main process without errors.
- All test plan scenarios pass.
- No memory leaks detected across repeated open/close cycles (run with --expose-gc).

## Files Modified
- `native/pdfium/` — New directory: C++ sources, headers, binding config
- `native/pdfium/binding.gyp` — Build configuration
- `native/pdfium/src/addon.cc` — N-API addon entry point
- `native/pdfium/src/document.cc` — Document lifecycle functions
- `native/pdfium/src/render.cc` — Page rendering
- `native/pdfium/src/objects.cc` — Object listing
- `package.json` — Add `node-addon-api` dev dependency and build scripts
