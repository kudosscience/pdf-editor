# 1-6 Packaging and signing per OS
[Back to task list](./tasks.md)

## Description
Configure electron-builder (and electron-wix-msi for Windows MSI) to produce installers for Windows (MSI via WiX), macOS (notarized DMG), and Linux (AppImage). Ensure the native PDFium addon is correctly included via `asarUnpack` and loads at runtime on all targets.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 21:25:00 | Status Change | Proposed | Agreed | Task approved by user | User |
| 2026-02-18 21:25:00 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 21:43:00 | Status Change | InProgress | Review | Implementation complete; NSIS installer verified on Windows | AI_Agent |

## Requirements
- **Windows MSI:** Use WiX Toolset via `electron-wix-msi`; define product code, upgrade code, desktop/start menu shortcuts; include native addon.
- **macOS DMG:** Use electron-builder `dmg` target; set hardened runtime and entitlements; notarize via Apple ID credentials (documented; CI secrets).
- **Linux AppImage:** Use electron-builder `AppImage` target; verify sandbox and addon loading.
- **Native addon:** Mark `native/pdfium/*.node` under `asarUnpack` in electron-builder config; verify runtime load path on all targets.
- **Offline:** Auto-update infrastructure disabled by default (no network calls); can be re-enabled in a future PBI.
- **Signing documentation:** README section documenting required certificates and environment variables for signing/notarization.

## Implementation Plan
1. Update `package.json` build config: add MSI target for Windows, keep DMG for macOS and AppImage for Linux.
2. Add `electron-wix-msi` dev dependency and MSI build script.
3. Configure `asarUnpack` for native addon paths.
4. Add entitlements plist for macOS hardened runtime.
5. Add CI workflow documentation (not CI config itself) for signing.
6. Test build on each platform; verify addon loads post-install.

## Test Plan
- **Build:** MSI, DMG, AppImage build without errors on respective platforms.
- **Install:** Install from each package; app launches and opens a PDF.
- **Addon:** Native addon loads; `pdf:open` and `pdf:render-page` succeed.
- **Offline:** No network calls observed during install or first launch.
- **Uninstall:** Clean removal without residual files (MSI and DMG).

## Verification
- **Windows NSIS installer**: Built successfully (82.76 MB). Silent install to temp directory succeeded. App launched and PDFium addon loaded (`[PdfiumEngine] Native addon loaded`). Process confirmed running.
- **Unpacked build**: `electron-builder --dir` produced working unpacked app. `PDF Editor.exe` launched without errors. `app.asar.unpacked/native/pdfium/build/Release/` contains `pdfium.node` + `pdfium.dll`. `resources/native-addon/` contains backup copies.
- **Addon path resolution**: `resolveAddonPath()` in `pdfium.ts` uses `app.isPackaged` to switch between dev-mode and packaged paths. Verified working in both modes.
- **Signing**: Skipped (no certificates configured). Documentation added to README.md covering `CSC_LINK`/`CSC_KEY_PASSWORD` (Windows) and `APPLE_ID`/`APPLE_APP_SPECIFIC_PASSWORD`/`APPLE_TEAM_ID` (macOS).
- **macOS/Linux**: Build config added but not tested (no macOS/Linux available). DMG and AppImage targets configured.
- **Auto-update**: `publish: null` — disabled by default.

## Files Modified
- `package.json` — Build targets, asarUnpack, extraResources, dist scripts, esbuild bundler step, electron-wix-msi dependency
- `src/main/pdfium.ts` — Added `resolveAddonPath()` for packaged vs dev-mode addon loading
- `build/entitlements.mac.plist` — macOS hardened runtime entitlements (new file)
- `scripts/build-msi.js` — MSI build script using electron-wix-msi (new file)
- `assets/icon.ico` — 256x256 Windows application icon (new file)
- `assets/icon.png` — 256x256 Linux application icon (new file)
- `README.md` — Packaging & Distribution section with signing/notarization docs
