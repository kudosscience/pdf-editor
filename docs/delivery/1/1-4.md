# 1-4 IPC and rendering pipeline
[Back to task list](./tasks.md)

## Description
Wire the PDFium façade into the Electron IPC layer by registering handlers for `pdf:open`, `pdf:close`, `pdf:get-page-count`, `pdf:render-page`, `pdf:list-objects`, and `pdf:save` channels. Implement an LRU bitmap cache to avoid redundant renders, enforce a concurrency limit on in-flight renders, and support cancellation of stale render requests on rapid page navigation.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements
- Register IPC handlers in `src/main/ipc-handlers.ts` for all `pdf:*` channels.
- Each handler: validate payload types and sizes → call `PdfiumEngine` method → return typed result.
- Emit `document:opened`, `document:saved`, `document:error` events to the renderer as appropriate.
- LRU bitmap cache keyed by `(docId, pageIndex, scale, rotation)` with total size bounded by `MAX_BITMAP_BYTES`.
- Concurrent render limiter: at most `RENDER_CONCURRENCY_LIMIT` renders in flight; queue excess.
- Render cancellation: maintain a generation counter per page; discard results from stale generations.
- Cap individual payload sizes: reject `pdf:open` data exceeding a reasonable limit; reject `pdf:replace-image` images exceeding `MAX_IMAGE_BYTES`.
- On `pdf:close`, flush cache entries for that docId.

## Implementation Plan
1. Add `pdf:*` channel constants to `src/shared/ipc-schema.ts`.
2. Add payload/result types to `src/shared/ipc-schema.ts`.
3. Import `PdfiumEngine` in `src/main/ipc-handlers.ts` and register handlers.
4. Implement `LruBitmapCache` class (Map + size tracking + eviction).
5. Implement `RenderQueue` with concurrency limiting and cancellation.
6. Wire event emission via `BrowserWindow.webContents.send()`.

## Test Plan
- **IPC Round-trip:** Invoke `pdf:open` from preload mock; receive `{ docId, pageCount }`.
- **Cache:** Render same page twice; second call returns cached bitmap (verify via spy).
- **Concurrency:** Fire `RENDER_CONCURRENCY_LIMIT + 2` renders; verify only limit in parallel.
- **Cancellation:** Fire rapid sequential renders for different pages; verify only the latest completes.
- **Validation:** Oversized payloads rejected with `document:error`.
- **Close Cleanup:** After `pdf:close`, cache entries for that docId are gone.

## Verification
- All `pdf:*` IPC handlers return typed results.
- Memory usage stays within `MAX_BITMAP_BYTES` under sustained rendering.
- Rapid navigation does not cause renderer stalls or stale renders.

## Files Modified
- `src/shared/ipc-schema.ts` — Add pdf:* channels and types
- `src/shared/constants.ts` — Add MAX_BITMAP_BYTES, RENDER_CONCURRENCY_LIMIT, MAX_IMAGE_BYTES
- `src/main/ipc-handlers.ts` — Register pdf:* handlers; implement cache and queue
- `src/preload/index.ts` — Expose window.api.pdf.* methods
